<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>St. Francis Quiz - Academic Decathlon 2026</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #f9fafb;
      color: #1f2937;
      line-height: 1.6;
      min-height: 100vh;
    }

    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      width: 100%;
      flex: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px 0;
    }

    .header h1 {
      color: #2c5282;
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .header p {
      color: #6b7280;
      font-size: 1rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 24px;
      margin-bottom: 20px;
    }

    .btn {
      display: inline-block;
      padding: 12px 24px;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 44px;
      width: 100%;
    }

    .btn-primary {
      background-color: #2c5282;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2b4c7e;
    }

    .btn-primary:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .btn-secondary {
      background-color: #d97706;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #b45309;
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid #2c5282;
      color: #2c5282;
    }

    .btn-outline:hover {
      background-color: #2c5282;
      color: white;
    }

    .btn-vocab {
      background-color: #7c3aed;
      color: white;
    }

    .btn-vocab:hover {
      background-color: #6d28d9;
    }

    .btn-vocab:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .btn-vocab-outline {
      background-color: transparent;
      border: 2px solid #7c3aed;
      color: #7c3aed;
    }

    .btn-vocab-outline:hover {
      background-color: #7c3aed;
      color: white;
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chapter-select {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background-color: white;
      cursor: pointer;
      min-height: 44px;
    }

    .chapter-select:focus {
      outline: none;
      border-color: #2c5282;
    }

    .chapter-select.vocab {
      border-color: #7c3aed;
    }

    .chapter-select.vocab:focus {
      border-color: #6d28d9;
    }

    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
    }

    .divider-line {
      flex: 1;
      height: 1px;
      background-color: #e5e7eb;
    }

    .divider-text {
      padding: 0 16px;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    .divider-text.vocab {
      color: #7c3aed;
    }

    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 12px 16px;
      background-color: #f3f4f6;
      border-radius: 8px;
    }

    .progress-bar.vocab {
      background-color: #f5f3ff;
    }

    .progress-text {
      font-weight: 500;
      color: #374151;
    }

    .chapter-tag {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .question-text {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 24px;
      color: #1f2937;
    }

    .vocab-prompt {
      font-size: 0.875rem;
      color: #7c3aed;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .vocab-definition {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 24px;
      color: #1f2937;
      font-style: italic;
      padding: 16px;
      background-color: #f5f3ff;
      border-radius: 8px;
      border-left: 4px solid #7c3aed;
    }

    .choices {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .choice {
      display: flex;
      align-items: center;
      padding: 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: white;
      text-align: left;
      min-height: 44px;
    }

    .choice:hover:not(.disabled) {
      border-color: #2c5282;
      background-color: #f0f7ff;
    }

    .choice.selected {
      border-color: #2c5282;
      background-color: #e8f0fe;
    }

    .choice.correct {
      border-color: #059669;
      background-color: #d1fae5;
    }

    .choice.incorrect {
      border-color: #dc2626;
      background-color: #fee2e2;
    }

    .choice.disabled {
      cursor: default;
    }

    .choice-letter {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      min-width: 28px;
      border-radius: 50%;
      background-color: #e5e7eb;
      font-weight: 600;
      font-size: 0.875rem;
      margin-right: 12px;
      color: #374151;
    }

    .choice.selected .choice-letter {
      background-color: #2c5282;
      color: white;
    }

    .choice.correct .choice-letter {
      background-color: #059669;
      color: white;
    }

    .choice.incorrect .choice-letter {
      background-color: #dc2626;
      color: white;
    }

    .choice-text {
      flex: 1;
      font-size: 1rem;
    }

    .feedback {
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .feedback.correct {
      background-color: #d1fae5;
      border: 2px solid #059669;
    }

    .feedback.incorrect {
      background-color: #fee2e2;
      border: 2px solid #dc2626;
    }

    .feedback-header {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      line-height: 1.5;
    }

    .feedback-icon {
      font-size: 1.25rem;
      line-height: 1.5;
    }

    .feedback-title {
      font-size: 1.125rem;
      font-weight: 600;
      white-space: nowrap;
      line-height: 1.5;
    }

    .feedback.correct .feedback-title {
      color: #059669;
    }

    .feedback.incorrect .feedback-title {
      color: #dc2626;
    }

    .feedback-body {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      min-width: 0;
    }

    .feedback-text {
      color: #374151;
      flex: 1;
      line-height: 1.5;
      padding-top: 3px;
    }

    .page-ref {
      font-size: 0.875rem;
      color: #6b7280;
      font-style: italic;
      flex-shrink: 0;
      text-align: right;
      line-height: 1.5;
      padding-top: 3px;
    }

    .results-score {
      text-align: center;
      padding: 30px 0;
    }

    .score-number {
      font-size: 3rem;
      font-weight: 700;
      color: #2c5282;
    }

    .score-percent {
      font-size: 1.5rem;
      color: #6b7280;
      margin-top: 8px;
    }

    .missed-section {
      margin-top: 30px;
    }

    .missed-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: #374151;
    }

    .missed-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .missed-item {
      padding: 16px;
      background-color: #fef2f2;
      border-radius: 8px;
      border-left: 4px solid #dc2626;
    }

    .missed-item.vocab {
      background-color: #faf5ff;
      border-left-color: #7c3aed;
    }

    .missed-question {
      font-weight: 500;
      margin-bottom: 8px;
    }

    .missed-answer {
      font-size: 0.875rem;
      color: #059669;
    }

    .missed-chapter {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .results-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 30px;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #2c5282;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      text-align: center;
      padding: 40px 20px;
      color: #dc2626;
    }

    .error-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2c5282;
    }

    .stat-value.vocab {
      color: #7c3aed;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
    }

    .name-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .name-input:focus {
      outline: none;
      border-color: #2c5282;
    }

    .welcome-text {
      text-align: center;
      margin-bottom: 24px;
      color: #374151;
    }

    .student-greeting {
      text-align: center;
      padding: 12px;
      background-color: #e8f0fe;
      border-radius: 8px;
      margin-bottom: 20px;
      color: #2c5282;
      font-weight: 500;
    }

    .change-name {
      font-size: 0.75rem;
      color: #6b7280;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 8px;
    }

    .change-name:hover {
      color: #2c5282;
    }

    .time-spent {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 8px;
    }

    .section-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .section-title.vocab {
      color: #7c3aed;
      border-bottom-color: #7c3aed;
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .header h1 {
        font-size: 1.5rem;
      }

      .card {
        padding: 16px;
      }

      .question-text {
        font-size: 1.125rem;
      }

      .choice {
        padding: 12px;
      }

      .score-number {
        font-size: 2.5rem;
      }

      .stats-bar {
        gap: 20px;
      }

      .feedback {
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 8px;
        padding: 16px;
      }

      .feedback-header {
        justify-content: center;
      }

      .feedback-body {
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .page-ref {
        text-align: center;
        padding-top: 0;
      }

      /* Compact correct answer on mobile - icon, title, message on one line */
      .feedback.correct {
        display: block;
        text-align: center;
      }

      .feedback.correct .feedback-header {
        display: inline-flex;
        vertical-align: middle;
      }

      .feedback.correct .feedback-body {
        display: inline;
      }

      .feedback.correct .feedback-text {
        display: inline;
        padding-top: 0;
        margin-left: 8px;
        vertical-align: middle;
      }

      .feedback.correct .page-ref {
        display: block;
        width: 100%;
        margin-top: 8px;
        padding-top: 0;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA_ZuZqAmUHn12SG_hShls9fANiaLrRf6c",
      authDomain: "decathlon-quiz-app.firebaseapp.com",
      projectId: "decathlon-quiz-app",
      storageBucket: "decathlon-quiz-app.firebasestorage.app",
      messagingSenderId: "956206924526",
      appId: "1:956206924526:web:7b9b6418a4ac41db6e29ff",
      measurementId: "G-BYGNTNH5WK"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Utility: Fisher-Yates shuffle
    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // Utility: Select random items from array
    function selectRandom(array, count) {
      const shuffled = shuffleArray(array);
      return shuffled.slice(0, count);
    }

    // Utility: Pick one random item from array
    function randomChoice(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    // Get adjacent chapters for vocabulary distractor pool
    function getAdjacentChapters(chapterNum) {
      if (chapterNum === 1) {
        return [1, 2, 3]; // First chapter: use first 3
      } else if (chapterNum === 18) {
        return [16, 17, 18]; // Last chapter: use last 3
      } else {
        return [chapterNum - 1, chapterNum, chapterNum + 1]; // Normal: prev, current, next
      }
    }

    // Select weighted distractors: 2 from current chapter, 1 from adjacent
    function selectWeightedDistractors(allVocabChapters, currentChapter, correctTerm, count) {
      const adjacentChapters = getAdjacentChapters(currentChapter);

      // Get all terms from current chapter (excluding correct answer)
      const currentChapterData = allVocabChapters.find(ch => ch.chapterNumber === currentChapter);
      const fromCurrent = currentChapterData
        ? currentChapterData.vocabulary
            .filter(v => v.term !== correctTerm)
            .map(v => v.term)
        : [];

      // Get all terms from adjacent chapters (excluding current chapter and correct answer)
      const fromAdjacent = adjacentChapters
        .filter(chNum => chNum !== currentChapter)
        .flatMap(chNum => {
          const chapterData = allVocabChapters.find(ch => ch.chapterNumber === chNum);
          return chapterData ? chapterData.vocabulary.map(v => v.term) : [];
        })
        .filter(term => term !== correctTerm);

      const selected = [];

      // Try to get 2 from current chapter
      if (fromCurrent.length >= 2) {
        selected.push(...selectRandom(fromCurrent, 2));
        // Get 1 from adjacent
        if (fromAdjacent.length >= 1) {
          selected.push(...selectRandom(fromAdjacent, 1));
        } else {
          // Fallback: get one more from current
          const remaining = fromCurrent.filter(t => !selected.includes(t));
          if (remaining.length > 0) {
            selected.push(...selectRandom(remaining, 1));
          }
        }
      } else {
        // Not enough in current chapter, take what we can
        selected.push(...shuffleArray(fromCurrent));
        const needed = count - selected.length;
        if (needed > 0 && fromAdjacent.length > 0) {
          selected.push(...selectRandom(fromAdjacent, needed));
        }
      }

      return selected.slice(0, count);
    }

    // Prepare a question with 4 randomized choices
    function prepareQuestion(question, chapterName, chapterNumber) {
      let correctAnswer;
      let distractors;

      // Handle "accept-any" type questions
      if (question.type === 'accept-any' && question.acceptableAnswers) {
        // Pick ONE random acceptable answer as the correct one for this attempt
        correctAnswer = randomChoice(question.acceptableAnswers);
        distractors = selectRandom(question.distractors, 3);
      } else {
        // Normal question
        correctAnswer = question.correctAnswer;
        distractors = selectRandom(question.distractors, 3);
      }

      const choices = shuffleArray([correctAnswer, ...distractors]);

      return {
        ...question,
        chapterName,
        chapterNumber,
        choices,
        correctAnswer, // This is the selected correct answer for this attempt
        isVocab: false
      };
    }

    // Prepare a vocabulary item as a question (with adjacent chapter distractors)
    function prepareVocabQuestion(vocabItem, chapterNumber, allVocabChapters) {
      // Use adjacent chapter logic to get distractors
      const distractors = selectWeightedDistractors(allVocabChapters, chapterNumber, vocabItem.term, 3);
      const choices = shuffleArray([vocabItem.term, ...distractors]);

      return {
        id: vocabItem.id,
        question: vocabItem.definition, // Definition is the question
        correctAnswer: vocabItem.term,  // Term is the answer
        term: vocabItem.term,
        definition: vocabItem.definition,
        choices,
        chapterNumber,
        pageReference: vocabItem.pageReference,
        isVocab: true
      };
    }

    // Format time in minutes and seconds
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      if (mins === 0) return `${secs} seconds`;
      return `${mins} min ${secs} sec`;
    }

    // Log quiz attempt to Firestore
    async function logQuizAttempt(data) {
      try {
        const docData = {
          studentName: data.studentName,
          quizMode: data.quizMode,
          score: data.score,
          total: data.total,
          percentage: data.percentage,
          timeSpent: data.timeSpent,
          attemptType: data.attemptType,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Use different field names for vocab vs questions
        if (data.attemptType === 'vocabulary') {
          docData.missedTerms = data.missedItems;
        } else {
          docData.missedQuestions = data.missedItems;
        }

        await db.collection('quizAttempts').add(docData);
        console.log('Quiz attempt logged successfully');
      } catch (error) {
        console.error('Error logging quiz attempt:', error);
      }
    }

    // Loading Screen Component
    function LoadingScreen() {
      return (
        <div className="container">
          <div className="loading">
            <div className="loading-spinner"></div>
            <p>Loading questions...</p>
          </div>
        </div>
      );
    }

    // Error Screen Component
    function ErrorScreen({ message, onRetry }) {
      return (
        <div className="container">
          <div className="card error">
            <div className="error-title">Error Loading Questions</div>
            <p>{message}</p>
            <button className="btn btn-primary" onClick={onRetry} style={{ marginTop: '20px', maxWidth: '200px' }}>
              Try Again
            </button>
          </div>
        </div>
      );
    }

    // Name Entry Screen Component
    function NameEntryScreen({ onSubmit }) {
      const [name, setName] = useState('');

      const handleSubmit = (e) => {
        e.preventDefault();
        if (name.trim()) {
          localStorage.setItem('studentName', name.trim());
          onSubmit(name.trim());
        }
      };

      return (
        <div className="container">
          <div className="header">
            <h1>St. Francis of Assisi Quiz</h1>
            <p>Academic Decathlon 2026</p>
          </div>

          <div className="card">
            <div className="welcome-text">
              <h2 style={{ marginBottom: '12px', color: '#2c5282' }}>Welcome!</h2>
              <p>Please enter your name to get started. This helps track your progress.</p>
            </div>

            <form onSubmit={handleSubmit}>
              <input
                type="text"
                className="name-input"
                placeholder="Enter your name..."
                value={name}
                onChange={(e) => setName(e.target.value)}
                autoFocus
              />
              <button
                type="submit"
                className="btn btn-primary"
                disabled={!name.trim()}
              >
                Start Studying
              </button>
            </form>
          </div>
        </div>
      );
    }

    // Start Screen Component
    function StartScreen({ chapters, vocabChapters, studentName, onStartQuiz, onStartVocabQuiz, onChangeName }) {
      const [selectedChapter, setSelectedChapter] = useState('');
      const [selectedVocabChapter, setSelectedVocabChapter] = useState('');

      const totalQuestions = chapters.reduce((sum, ch) => sum + ch.questions.length, 0);
      const totalVocab = vocabChapters.reduce((sum, ch) => sum + ch.vocabulary.length, 0);

      const handleChapterQuiz = () => {
        if (selectedChapter) {
          const chapter = chapters.find(ch => ch.chapterNumber === parseInt(selectedChapter));
          const questions = chapter.questions.map(q =>
            prepareQuestion(q, chapter.chapterName, chapter.chapterNumber)
          );
          onStartQuiz(questions, `Chapter ${chapter.chapterNumber}: ${chapter.chapterName}`);
        }
      };

      const handleAllChapters = () => {
        const allQuestions = chapters.flatMap(ch =>
          ch.questions.map(q => prepareQuestion(q, ch.chapterName, ch.chapterNumber))
        );
        onStartQuiz(shuffleArray(allQuestions), 'All Chapters');
      };

      const handleRandomQuiz = (count) => {
        const allQuestions = chapters.flatMap(ch =>
          ch.questions.map(q => prepareQuestion(q, ch.chapterName, ch.chapterNumber))
        );
        const selected = selectRandom(allQuestions, Math.min(count, allQuestions.length));
        onStartQuiz(selected, `Random ${count} Questions`);
      };

      const handleVocabChapterQuiz = () => {
        if (selectedVocabChapter) {
          const chapter = vocabChapters.find(ch => ch.chapterNumber === parseInt(selectedVocabChapter));
          const questions = chapter.vocabulary.map(v =>
            prepareVocabQuestion(v, chapter.chapterNumber, vocabChapters)
          );
          onStartVocabQuiz(questions, `Vocabulary - Chapter ${chapter.chapterNumber}`);
        }
      };

      const handleAllVocab = () => {
        const allVocab = vocabChapters.flatMap(ch =>
          ch.vocabulary.map(v => prepareVocabQuestion(v, ch.chapterNumber, vocabChapters))
        );
        onStartVocabQuiz(shuffleArray(allVocab), 'Vocabulary - All Chapters');
      };

      return (
        <div className="container">
          <div className="header">
            <h1>St. Francis of Assisi Quiz</h1>
            <p>Academic Decathlon 2026</p>
          </div>

          <div className="card">
            <div className="student-greeting">
              Welcome back, {studentName}!
              <span className="change-name" onClick={onChangeName}>change</span>
            </div>

            <div className="stats-bar">
              <div className="stat-item">
                <div className="stat-value">{chapters.length}</div>
                <div className="stat-label">Chapters</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">{totalQuestions}</div>
                <div className="stat-label">Questions</div>
              </div>
              <div className="stat-item">
                <div className="stat-value vocab">{totalVocab}</div>
                <div className="stat-label">Vocab Terms</div>
              </div>
            </div>

            <div className="menu-buttons">
              {/* Questions Section */}
              <div className="section-title">Review Questions</div>

              <select
                className="chapter-select"
                value={selectedChapter}
                onChange={(e) => setSelectedChapter(e.target.value)}
              >
                <option value="">Select a Chapter...</option>
                {chapters.map(ch => (
                  <option key={ch.chapterNumber} value={ch.chapterNumber}>
                    Ch. {ch.chapterNumber}: {ch.chapterName} ({ch.questions.length} questions)
                  </option>
                ))}
              </select>

              <button
                className="btn btn-primary"
                onClick={handleChapterQuiz}
                disabled={!selectedChapter}
              >
                Start Chapter Quiz
              </button>

              <button className="btn btn-secondary" onClick={handleAllChapters}>
                All Chapters ({totalQuestions} questions)
              </button>

              <div className="divider">
                <div className="divider-line"></div>
                <span className="divider-text">RANDOM</span>
                <div className="divider-line"></div>
              </div>

              <button className="btn btn-outline" onClick={() => handleRandomQuiz(10)}>
                Random 10 Questions
              </button>
              <button className="btn btn-outline" onClick={() => handleRandomQuiz(25)}>
                Random 25 Questions
              </button>
              <button className="btn btn-outline" onClick={() => handleRandomQuiz(50)}>
                Random 50 Questions
              </button>

              {/* Vocabulary Section */}
              <div className="divider">
                <div className="divider-line"></div>
                <span className="divider-text vocab">VOCABULARY</span>
                <div className="divider-line"></div>
              </div>

              <div className="section-title vocab">Vocabulary Quiz</div>

              <select
                className="chapter-select vocab"
                value={selectedVocabChapter}
                onChange={(e) => setSelectedVocabChapter(e.target.value)}
              >
                <option value="">Select a Chapter...</option>
                {vocabChapters.map(ch => (
                  <option key={ch.chapterNumber} value={ch.chapterNumber}>
                    Ch. {ch.chapterNumber} Vocabulary ({ch.vocabulary.length} terms)
                  </option>
                ))}
              </select>

              <button
                className="btn btn-vocab"
                onClick={handleVocabChapterQuiz}
                disabled={!selectedVocabChapter}
              >
                Start Vocabulary Quiz
              </button>

              <button className="btn btn-vocab-outline" onClick={handleAllVocab}>
                All Vocabulary ({totalVocab} terms)
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Quiz Screen Component
    function QuizScreen({ questions, quizTitle, isVocab, onComplete }) {
      const [currentIndex, setCurrentIndex] = useState(0);
      const [selectedAnswer, setSelectedAnswer] = useState(null);
      const [showFeedback, setShowFeedback] = useState(false);
      const [userAnswers, setUserAnswers] = useState([]);
      const startTimeRef = useRef(Date.now());

      const currentQuestion = questions[currentIndex];
      const isCorrect = selectedAnswer === currentQuestion.correctAnswer;
      const letters = ['A', 'B', 'C', 'D'];

      const handleSubmit = () => {
        if (selectedAnswer === null) return;

        setUserAnswers([...userAnswers, {
          question: currentQuestion,
          userAnswer: selectedAnswer,
          correct: isCorrect
        }]);
        setShowFeedback(true);
      };

      const handleNext = () => {
        if (currentIndex + 1 >= questions.length) {
          const finalAnswers = [...userAnswers, {
            question: currentQuestion,
            userAnswer: selectedAnswer,
            correct: isCorrect
          }];
          const timeSpent = Math.round((Date.now() - startTimeRef.current) / 1000);
          onComplete(finalAnswers, timeSpent);
        } else {
          setCurrentIndex(currentIndex + 1);
          setSelectedAnswer(null);
          setShowFeedback(false);
        }
      };

      const getChoiceClass = (choice) => {
        let className = 'choice';
        if (showFeedback) {
          className += ' disabled';
          if (choice === currentQuestion.correctAnswer) {
            className += ' correct';
          } else if (choice === selectedAnswer) {
            className += ' incorrect';
          }
        } else if (choice === selectedAnswer) {
          className += ' selected';
        }
        return className;
      };

      return (
        <div className="container">
          <div className="card">
            <div className={`progress-bar ${isVocab ? 'vocab' : ''}`}>
              <span className="progress-text">
                {isVocab ? 'Term' : 'Question'} {currentIndex + 1} of {questions.length}
              </span>
              <span className="chapter-tag">
                {isVocab ? `Vocab Ch. ${currentQuestion.chapterNumber}` : `Ch. ${currentQuestion.chapterNumber}: ${currentQuestion.chapterName}`}
              </span>
            </div>

            {isVocab ? (
              <>
                <div className="vocab-prompt">Which term matches this definition?</div>
                <div className="vocab-definition">"{currentQuestion.question}"</div>
              </>
            ) : (
              <div className="question-text">{currentQuestion.question}</div>
            )}

            <div className="choices">
              {currentQuestion.choices.map((choice, index) => (
                <button
                  key={index}
                  className={getChoiceClass(choice)}
                  onClick={() => !showFeedback && setSelectedAnswer(choice)}
                  disabled={showFeedback}
                >
                  <span className="choice-letter">{letters[index]}</span>
                  <span className="choice-text">{choice}</span>
                </button>
              ))}
            </div>

            {showFeedback && (
              <div className={`feedback ${isCorrect ? 'correct' : 'incorrect'}`}>
                <div className="feedback-header">
                  <div className="feedback-icon">{isCorrect ? '✓' : '✗'}</div>
                  <div className="feedback-title">
                    {isCorrect ? 'Correct!' : 'Incorrect'}
                  </div>
                </div>
                <div className="feedback-body">
                  <div className="feedback-text">
                    {isCorrect
                      ? 'Great job!'
                      : isVocab
                        ? `The correct term is: ${currentQuestion.correctAnswer}`
                        : `The correct answer is: ${currentQuestion.correctAnswer}`
                    }
                  </div>
                  <div className="page-ref">Page reference: {currentQuestion.pageReference}</div>
                </div>
              </div>
            )}

            {!showFeedback ? (
              <button
                className={`btn ${isVocab ? 'btn-vocab' : 'btn-primary'}`}
                onClick={handleSubmit}
                disabled={selectedAnswer === null}
              >
                Submit Answer
              </button>
            ) : (
              <button className="btn btn-secondary" onClick={handleNext}>
                {currentIndex + 1 >= questions.length ? 'See Results' : isVocab ? 'Next Term' : 'Next Question'}
              </button>
            )}
          </div>
        </div>
      );
    }

    // Results Screen Component
    function ResultsScreen({ answers, quizTitle, timeSpent, isVocab, onReviewMissed, onRetry, onMenu }) {
      const correct = answers.filter(a => a.correct).length;
      const total = answers.length;
      const percent = Math.round((correct / total) * 100);
      const missed = answers.filter(a => !a.correct);

      return (
        <div className="container">
          <div className="header">
            <h1>Quiz Complete!</h1>
            <p>{quizTitle}</p>
          </div>

          <div className="card">
            <div className="results-score">
              <div className="score-number">{correct}/{total}</div>
              <div className="score-percent">{percent}%</div>
              <div className="time-spent">Time: {formatTime(timeSpent)}</div>
            </div>

            {missed.length > 0 && (
              <div className="missed-section">
                <div className="missed-title">{isVocab ? 'Terms' : 'Questions'} Missed: {missed.length}</div>
                <div className="missed-list">
                  {missed.map((item, index) => (
                    <div key={index} className={`missed-item ${isVocab ? 'vocab' : ''}`}>
                      {isVocab ? (
                        <>
                          <div className="missed-question">"{item.question.definition}"</div>
                          <div className="missed-answer">
                            Correct term: <strong>{item.question.term}</strong>
                          </div>
                        </>
                      ) : (
                        <>
                          <div className="missed-question">{item.question.question}</div>
                          <div className="missed-answer">
                            Correct: {item.question.correctAnswer}
                          </div>
                          <div className="missed-chapter">
                            Chapter {item.question.chapterNumber}: {item.question.chapterName} (p. {item.question.pageReference})
                          </div>
                        </>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="results-buttons">
              {missed.length > 0 && (
                <button className={`btn ${isVocab ? 'btn-vocab' : 'btn-secondary'}`} onClick={onReviewMissed}>
                  Review Missed {isVocab ? 'Terms' : 'Questions'} ({missed.length})
                </button>
              )}
              {missed.length > 0 && (
                <button className="btn btn-primary" onClick={onRetry}>
                  Try Again
                </button>
              )}
              <button className="btn btn-outline" onClick={onMenu}>
                Return to Menu
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Main App Component
    function App() {
      const [mode, setMode] = useState('loading');
      const [chapters, setChapters] = useState([]);
      const [vocabChapters, setVocabChapters] = useState([]);
      const [error, setError] = useState(null);
      const [quizQuestions, setQuizQuestions] = useState([]);
      const [quizTitle, setQuizTitle] = useState('');
      const [quizAnswers, setQuizAnswers] = useState([]);
      const [lastQuizConfig, setLastQuizConfig] = useState(null);
      const [studentName, setStudentName] = useState('');
      const [timeSpent, setTimeSpent] = useState(0);
      const [isVocabQuiz, setIsVocabQuiz] = useState(false);

      // Check for stored name and load chapters on mount
      useEffect(() => {
        const storedName = localStorage.getItem('studentName');
        if (storedName) {
          setStudentName(storedName);
        }
        loadAllData();
      }, []);

      const loadAllData = async () => {
        setMode('loading');
        setError(null);

        try {
          // Load question chapters
          const loadedChapters = [];
          for (let i = 1; i <= 18; i++) {
            const paddedNum = i.toString().padStart(2, '0');
            const response = await fetch(`./data/st-francis-ch${paddedNum}.json`);
            if (!response.ok) {
              throw new Error(`Failed to load chapter ${i}`);
            }
            const chapter = await response.json();
            loadedChapters.push(chapter);
          }
          loadedChapters.sort((a, b) => a.chapterNumber - b.chapterNumber);
          setChapters(loadedChapters);

          // Load vocabulary chapters
          const loadedVocab = [];
          for (let i = 1; i <= 18; i++) {
            const paddedNum = i.toString().padStart(2, '0');
            const response = await fetch(`./data/vocab/vocab-ch${paddedNum}.json`);
            if (!response.ok) {
              throw new Error(`Failed to load vocab chapter ${i}`);
            }
            const vocab = await response.json();
            loadedVocab.push(vocab);
          }
          loadedVocab.sort((a, b) => a.chapterNumber - b.chapterNumber);
          setVocabChapters(loadedVocab);

          // Check if we need name entry
          const storedName = localStorage.getItem('studentName');
          if (storedName) {
            setMode('menu');
          } else {
            setMode('nameEntry');
          }
        } catch (err) {
          setError('Could not load questions. Please check that all chapter files are in the /data folder.');
          setMode('error');
        }
      };

      const handleNameSubmit = (name) => {
        setStudentName(name);
        setMode('menu');
      };

      const handleChangeName = () => {
        localStorage.removeItem('studentName');
        setStudentName('');
        setMode('nameEntry');
      };

      const handleStartQuiz = (questions, title) => {
        setQuizQuestions(questions);
        setQuizTitle(title);
        setLastQuizConfig({ questions, title, isVocab: false });
        setIsVocabQuiz(false);
        setMode('quiz');
      };

      const handleStartVocabQuiz = (questions, title) => {
        setQuizQuestions(questions);
        setQuizTitle(title);
        setLastQuizConfig({ questions, title, isVocab: true });
        setIsVocabQuiz(true);
        setMode('quiz');
      };

      const handleQuizComplete = async (answers, elapsed) => {
        setQuizAnswers(answers);
        setTimeSpent(elapsed);
        setMode('results');

        // Log to Firestore
        const correct = answers.filter(a => a.correct).length;
        const total = answers.length;

        let missedItems;
        if (isVocabQuiz) {
          missedItems = answers.filter(a => !a.correct).map(a => ({
            termId: a.question.id,
            term: a.question.term,
            definition: a.question.definition,
            userAnswer: a.userAnswer,
            correctAnswer: a.question.term,
            chapterNumber: a.question.chapterNumber,
            pageReference: a.question.pageReference
          }));
        } else {
          missedItems = answers.filter(a => !a.correct).map(a => ({
            questionId: a.question.id,
            question: a.question.question,
            correctAnswer: a.question.correctAnswer,
            userAnswer: a.userAnswer,
            chapterNumber: a.question.chapterNumber,
            chapterName: a.question.chapterName,
            pageReference: a.question.pageReference
          }));
        }

        await logQuizAttempt({
          studentName: studentName,
          quizMode: quizTitle,
          score: correct,
          total: total,
          percentage: Math.round((correct / total) * 100),
          timeSpent: elapsed,
          attemptType: isVocabQuiz ? 'vocabulary' : 'questions',
          missedItems: missedItems
        });
      };

      const handleReviewMissed = () => {
        const missed = quizAnswers.filter(a => !a.correct);
        let reviewQuestions;

        if (isVocabQuiz) {
          reviewQuestions = missed.map(m => {
            const vocabItem = {
              id: m.question.id,
              term: m.question.term,
              definition: m.question.definition,
              pageReference: m.question.pageReference
            };
            return prepareVocabQuestion(vocabItem, m.question.chapterNumber, vocabChapters);
          });
        } else {
          reviewQuestions = missed.map(m =>
            prepareQuestion(m.question, m.question.chapterName, m.question.chapterNumber)
          );
        }

        setQuizQuestions(reviewQuestions);
        setQuizTitle(`Review: Missed ${isVocabQuiz ? 'Terms' : 'Questions'}`);
        setMode('quiz');
      };

      const handleRetry = () => {
        if (lastQuizConfig) {
          let freshQuestions;
          if (lastQuizConfig.isVocab) {
            freshQuestions = lastQuizConfig.questions.map(q => {
              const vocabItem = {
                id: q.id,
                term: q.term,
                definition: q.definition,
                pageReference: q.pageReference
              };
              return prepareVocabQuestion(vocabItem, q.chapterNumber, vocabChapters);
            });
          } else {
            freshQuestions = lastQuizConfig.questions.map(q =>
              prepareQuestion(q, q.chapterName, q.chapterNumber)
            );
          }
          setQuizQuestions(shuffleArray(freshQuestions));
          setQuizTitle(lastQuizConfig.title);
          setIsVocabQuiz(lastQuizConfig.isVocab);
          setMode('quiz');
        }
      };

      const handleMenu = () => {
        setQuizQuestions([]);
        setQuizAnswers([]);
        setIsVocabQuiz(false);
        setMode('menu');
      };

      if (mode === 'loading') {
        return <LoadingScreen />;
      }

      if (mode === 'error') {
        return <ErrorScreen message={error} onRetry={loadAllData} />;
      }

      if (mode === 'nameEntry') {
        return <NameEntryScreen onSubmit={handleNameSubmit} />;
      }

      if (mode === 'menu') {
        return (
          <StartScreen
            chapters={chapters}
            vocabChapters={vocabChapters}
            studentName={studentName}
            onStartQuiz={handleStartQuiz}
            onStartVocabQuiz={handleStartVocabQuiz}
            onChangeName={handleChangeName}
          />
        );
      }

      if (mode === 'quiz') {
        return (
          <QuizScreen
            questions={quizQuestions}
            quizTitle={quizTitle}
            isVocab={isVocabQuiz}
            onComplete={handleQuizComplete}
          />
        );
      }

      if (mode === 'results') {
        return (
          <ResultsScreen
            answers={quizAnswers}
            quizTitle={quizTitle}
            timeSpent={timeSpent}
            isVocab={isVocabQuiz}
            onReviewMissed={handleReviewMissed}
            onRetry={handleRetry}
            onMenu={handleMenu}
          />
        );
      }

      return null;
    }

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
